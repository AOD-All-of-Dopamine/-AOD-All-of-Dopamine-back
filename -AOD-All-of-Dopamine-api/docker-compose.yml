version: '3.8'
# Docker Compose íŒŒì¼ ë²„ì „ - ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤íƒ ì „ìš©

services:
  # ========== Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ==========
  app:
    # âœ¨ [í•µì‹¬] CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œëŠ” APP_IMAGE_URI í™˜ê²½ë³€ìˆ˜ë¥¼ ì£¼ì…ë°›ì•„ ECR ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    # ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì´ ë³€ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ build: . ì„¤ì •ì„ í†µí•´ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë¹Œë“œí•©ë‹ˆë‹¤.
    image: ${APP_IMAGE_URI:-aod-app:latest}
    container_name: aod-app
    ports:
      - "${APP_PORT:-8080}:8080"
    environment:
      TZ: Asia/Seoul
      # JVM ë©”ëª¨ë¦¬ ì„¤ì • (t3.small ìµœì í™”: Heap ìµœëŒ€ 512MB)
      JAVA_TOOL_OPTIONS: "-Duser.timezone=Asia/Seoul -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-prod}

      # âœ¨ [í•µì‹¬ ìˆ˜ì •] ì™¸ë¶€ DB ë° Seleniumì„ ì°¸ì¡°í•˜ë„ë¡ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
      # ì´ ê°’ë“¤ì€ GitHub Actions Secretsë¥¼ í†µí•´ ì£¼ì…ë©ë‹ˆë‹¤.
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      TMDB_API_KEY: ${TMDB_API_KEY}
      STEAM_API_KEY: ${STEAM_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      
      # Sentry ì—ëŸ¬ ì¶”ì 
      SENTRY_DSN: ${SENTRY_DSN}

    # ë¦¬ì†ŒìŠ¤ ì œí•œ (t3.small ìµœì í™”)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1.5G
        reservations:
          cpus: '0.5'
          memory: 512M

    # ğŸš€ ë¡œê·¸ íŒŒì¼ ì˜êµ¬ ì €ì¥ (í˜¸ìŠ¤íŠ¸ì— ë§ˆìš´íŠ¸)
    volumes:
      - ./logs:/app/logs  # ë¡œê·¸ íŒŒì¼ì„ í˜¸ìŠ¤íŠ¸ì— ì €ì¥
    
    # ğŸ”¥ Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ rotation (ë””ìŠ¤í¬ ê³µê°„ ë³´í˜¸)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # ê° ë¡œê·¸ íŒŒì¼ ìµœëŒ€ 10MB
        max-file: "3"        # ìµœëŒ€ 3ê°œ íŒŒì¼ ë³´ê´€ (ì´ 30MB)
        compress: "true"     # ë¡œê·¸ ì••ì¶• í™œì„±í™”

    networks:
      - aod-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ========== ë„¤íŠ¸ì›Œí¬ ì •ì˜ ==========
# ë‹¤ë¥¸ ìŠ¤íƒ(ì˜ˆ: ëª¨ë‹ˆí„°ë§)ê³¼ í†µì‹ ì´ í•„ìš”í•  ê²½ìš° external networkë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
networks:
  aod-network:
    driver: bridge
