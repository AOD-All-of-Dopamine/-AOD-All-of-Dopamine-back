<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">

<section layout:fragment="content" class="admin-page">

    <h2>🛠️ 데모 데이터 관리자 페이지</h2>
    <p>이 페이지에서 데모에 필요한 데이터를 수집하고 처리할 수 있습니다. 각 섹션에서 원하는 조건을 입력하고 수집 버튼을 누르세요.</p>
    <div id="status-message" class="status-message"></div>

    <div class="admin-section">
        <h3>1. 데이터 수집 (Crawling)</h3>

        <div class="platform-section">
            <h4>🎬 TMDB (영화/TV쇼)</h4>
            <div class="input-group">
                <button onclick="callApi('/api/crawl/tmdb/new-content', 'POST', null, 'TMDB 신규 콘텐츠')">신규 콘텐츠 수집 (최근 7일)</button>
            </div>
            <p class="description">최근 7일간의 영화 및 TV 쇼를 Job Queue에 등록합니다. Consumer가 백그라운드에서 처리합니다.</p>
        </div>

        <div class="platform-section">
            <h4>🎮 Steam (게임)</h4>
            <div class="input-group">
                <label for="steam-appid">특정 게임 AppID:</label>
                <input type="number" id="steam-appid" placeholder="예: 730 (CS2)" class="form-input">
                <button onclick="callSteamByAppIdApi()">AppID로 수집</button>
            </div>
            <p class="description">특정 게임의 AppID를 입력하여 개별 수집합니다.</p>
            <hr>
            <div class="input-group">
                <label for="steam-start-index">시작 인덱스:</label>
                <input type="number" id="steam-start-index" value="0" class="form-input">
                <label for="steam-end-index">종료 인덱스:</label>
                <input type="number" id="steam-end-index" value="100" class="form-input">
                <button onclick="callSteamApi()">범위 지정 수집</button>
                <button onclick="callApi('/api/crawl/steam/all-games', 'POST', null, 'Steam 전체 게임 수집')">전체 게임 수집 (Job Queue 등록)</button>
            </div>
            <p class="description">범위를 지정하거나, 전체 게임(1000개씩 자동 분할)을 수집합니다.</p>
        </div>

        <div class="platform-section">
            <h4>📖 네이버 웹툰</h4>
            <div class="input-group">
                <label for="webtoon-pages">완결 (페이지 수):</label>
                <input type="number" id="webtoon-pages" value="5" class="form-input">
                <button onclick="callWebtoonFinishedApi()">완결 웹툰 수집</button>
            </div>
            <div class="input-group">
                <label for="webtoon-weekday">요일 지정:</label>
                <select id="webtoon-weekday" class="form-input">
                    <option value="mon">월요일</option>
                    <option value="tue">화요일</option>
                    <option value="wed">수요일</option>
                    <option value="thu">목요일</option>
                    <option value="fri">금요일</option>
                    <option value="sat">토요일</option>
                    <option value="sun">일요일</option>
                </select>
                <button onclick="callWebtoonWeekdayApi()">요일별 수집</button>
                <button onclick="callApi('/api/crawl/naver-webtoon/all-weekdays', 'POST', null, '네이버 웹툰 전체 요일 수집')">전체 요일 수집 (Job Queue 등록)</button>
            </div>
        </div>

        <div class="platform-section">
            <h4>📚 웹소설 (네이버 시리즈 / 카카오페이지)</h4>

            <div class="input-group-sub">
                <h5>네이버 시리즈</h5>
                <label for="ns-novel-pages">수집 페이지 수:</label>
                <input type="number" id="ns-novel-pages" value="2" class="form-input">
                <button onclick="callNaverSeriesApi()">네이버 시리즈 인기작 수집</button>
            </div>
            <hr>
            <div class="input-group-sub">
                <h5>카카오페이지</h5>
                <div class="input-row">
                    <label for="kp-genre">장르:</label>
                    <select id="kp-genre" class="form-input">
                        <option value="0">전체</option>
                        <option value="86">판타지</option>
                        <option value="120">현대판타지</option>
                        <option value="117">로맨스판타지</option>
                        <option value="89">로맨스</option>
                        <option value="87">무협</option>
                    </select>
                </div>
                <div class="input-row">
                    <label for="kp-sort-type">정렬:</label>
                    <select id="kp-sort-type" class="form-input">
                        <option value="UPDATE">업데이트 순</option>
                        <option value="PRODUCT_LATEST">등록일 순</option>
                    </select>
                    <label for="kp-is-complete">완결 여부:</label>
                    <select id="kp-is-complete" class="form-input">
                        <option value="false">연재중</option>
                        <option value="true">완결</option>
                    </select>
                </div>
                <div class="input-row">
                    <label for="kp-novel-pages">수집 페이지 수:</label>
                    <input type="number" id="kp-novel-pages" value="2" class="form-input">
                    <button onclick="callKakaoPageApi()">카카오페이지 조건별 수집</button>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h3>2. 수집 데이터 통합 처리 (Batch Process)</h3>
        <div class="input-group">
            <label for="batch-size">배치 크기:</label>
            <input type="number" id="batch-size" value="100" class="form-input">
            <button onclick="callBatchProcessApi()">수집된 데이터 통합 실행</button>
            <button onclick="callApi('/api/batch/transform-daily', 'POST', null, '일일 배치 변환 (스케줄러 로직)')">🚀 일일 배치 변환 (전체)</button>
        </div>
        <p class="description">
            데이터 수집 후, 이 버튼을 눌러야 수집된 원본(`RawItem`) 데이터가 분석 및 정규화 과정을 거쳐 최종 콘텐츠(`Content`) DB에 저장됩니다.
            배치 크기를 조정하여 한 번에 처리할 데이터 개수를 설정할 수 있습니다.
            <br><strong>🚀 일일 배치 변환:</strong> 스케줄러가 매일 새벽 6시에 실행하는 것과 동일한 로직으로, 미처리 데이터를 100개씩 모두 처리합니다.
        </p>
    </div>

    <script>
        // 범용 API 호출 함수
        function callApi(endpoint, method, body, taskName) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = `⏳ '${taskName}' 작업을 시작합니다... (엔드포인트: ${endpoint})`;
            statusDiv.className = 'status-message-processing';

            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };

            if (method.toUpperCase() !== 'GET' && body) {
                options.body = JSON.stringify(body);
            }

            fetch(endpoint, options)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(`[${response.status}] ${text || response.statusText}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    const message = data.message || `성공적으로 완료되었습니다.`;
                    statusDiv.textContent = `✅ '${taskName}' 작업 성공: ${message}`;
                    statusDiv.className = 'status-message-success';
                })
                .catch(error => {
                    console.error('API Call Error:', error);
                    statusDiv.textContent = `❌ '${taskName}' 작업 실패: ${error.message}`;
                    statusDiv.className = 'status-message-error';
                });
        }

        // --- 각 플랫폼별 API 호출 래퍼 함수 ---

        function callTmdbApi(baseEndpoint, taskName) {
            const startYear = document.getElementById('tmdb-start-year').value;
            const endYear = document.getElementById('tmdb-end-year').value;
            const endpoint = `${baseEndpoint}?startYear=${startYear}&endYear=${endYear}`;
            callApi(endpoint, 'POST', null, taskName);
        }

        // [개선] 인기 샘플 수집 함수를 영화/TV쇼 공용으로 변경
        function callTmdbPopularSampleApi(endpoint, taskName) {
            const pages = document.getElementById('tmdb-sample-pages').value;
            const fullEndpoint = `${endpoint}?pages=${pages}`;
            callApi(fullEndpoint, 'POST', null, taskName);
        }

        // [개선] 연도별 샘플 수집 함수를 영화/TV쇼 공용으로 변경
        function callTmdbYearSampleApi(endpoint, taskName) {
            const year = document.getElementById('tmdb-sample-year').value;
            const pages = document.getElementById('tmdb-sample-year-pages').value;
            const fullEndpoint = `${endpoint}?year=${year}&pages=${pages}`;
            callApi(fullEndpoint, 'POST', null, taskName);
        }

        function callSteamByAppIdApi() {
            const appId = document.getElementById('steam-appid').value;
            if (!appId || appId.trim() === '') {
                alert('AppID를 입력해주세요.');
                return;
            }
            const body = { appId: parseInt(appId) };
            callApi('/api/steam/collect/by-appid', 'POST', body, `Steam 게임 AppID ${appId} 수집`);
        }

        function callSteamApi() {
            const start = document.getElementById('steam-start-index').value;
            const end = document.getElementById('steam-end-index').value;
            const endpoint = `/api/test/steam/collect-games-by-range?start=${start}&end=${end}`;
            callApi(endpoint, 'POST', null, 'Steam 범위 지정 수집');
        }

        function callWebtoonFinishedApi() {
            const maxPages = document.getElementById('webtoon-pages').value;
            const body = {}; // Job Queue 방식은 파라미터 불필요
            callApi('/api/crawl/naver-webtoon/finished', 'POST', body, '네이버 완결 웹툰 수집 (Job Queue)');
        }

        function callWebtoonWeekdayApi() {
            const weekday = document.getElementById('webtoon-weekday').value;
            const body = { weekday: weekday };
            callApi('/api/crawl/naver-webtoon/weekday', 'POST', body, `네이버 ${weekday}요일 웹툰 수집 (Job Queue)`);
        }

        // 네이버 시리즈 API 호출 함수 (Job Queue 패턴 사용)
        function callNaverSeriesApi() {
            const pages = document.getElementById('ns-novel-pages').value;
            // Query parameter로 전달 (Body 없음)
            fetch(`/api/crawl/naver-series/popular?maxPages=${pages}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                alert(`✅ 네이버 시리즈 인기작 수집 완료\n\n발견: ${data.foundNovelIds}개\n생성: ${data.jobsCreated}개 작업\n\n${data.message}`);
                console.log('응답:', data);
            })
            .catch(error => {
                alert('❌ 오류 발생: ' + error);
                console.error('Error:', error);
            });
        }

        // 카카오페이지 API 호출 함수 (새로운 컨트롤러에 맞게 대폭 수정)
        function callKakaoPageApi() {
            // 새로 추가된 UI에서 값들을 읽어옵니다.
            const categoryUid = 11; // 11: 웹소설 (고정)
            const subcategoryUid = document.getElementById('kp-genre').value;
            const sortType = document.getElementById('kp-sort-type').value;
            const isComplete = document.getElementById('kp-is-complete').value;
            const pages = document.getElementById('kp-novel-pages').value;

            // sectionId를 조합하여 생성합니다. (컨트롤러의 기본값 생성 로직과 유사)
            const sectionId = `static-landing-Genre-section-Landing-${categoryUid}-${subcategoryUid}-${sortType}-${isComplete}`;

            // 새로운 API DTO 형식에 맞는 body 객체를 생성합니다.
            const body = {
                sectionId: sectionId,
                categoryUid: parseInt(categoryUid),
                subcategoryUid: subcategoryUid,
                sortType: sortType,
                isComplete: (isComplete === 'true'), // 문자열 'true'를 boolean true로 변환
                pages: parseInt(pages)
            };

            // 새로운 엔드포인트를 호출합니다.
            callApi('/api/crawl/kakaopage/api', 'POST', body, '카카오페이지 웹소설 수집');
        }

        // 배치 처리 API 호출 함수
        function callBatchProcessApi() {
            const batchSize = document.getElementById('batch-size').value;
            const body = { batchSize: parseInt(batchSize) };
            callApi('/api/batch/process', 'POST', body, '데이터 통합 처리');
        }

    </script>
</section>

</html>